name: huntx

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:
    inputs:
      max_workers:
        description: "Number of parallel ingestion workers"
        required: false
        default: "2"
      bot_timeout:
        description: "Post-pipeline bot window (seconds, 0=skip)"
        required: false
        default: "60"
      reset:
        description: "Factory reset before run (wipe all state/data/outputs)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: huntx
  cancel-in-progress: false

env:
  MAX_WORKERS: ${{ github.event.inputs.max_workers || '2' }}
  BOT_TIMEOUT: ${{ github.event.inputs.bot_timeout || '60' }}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          docker system prune -af 2>/dev/null || true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Prepare directories
        run: mkdir -p persist/data/{raw,output,dist,rejects,archive,state,logs}

      - name: Restore state
        run: |
          git fetch origin huntx-state:huntx-state 2>/dev/null || echo "No state branch yet"

          if git show huntx-state:state.db > persist/state.db 2>/dev/null; then
            echo "Restored state.db"
          else
            echo "Starting fresh"
          fi

          if git ls-tree -d huntx-state:data_archive >/dev/null 2>&1; then
            git checkout huntx-state -- data_archive
            cp -r data_archive/* persist/data/archive/ 2>/dev/null || true
            rm -rf data_archive
          fi

      - name: Factory reset (if requested)
        if: ${{ github.event.inputs.reset == 'true' }}
        run: |
          echo "=== FACTORY RESET ==="
          rm -rf persist/state.db persist/data/{raw,output,archive,dist,rejects,artifacts,state,logs}/*
          rm -rf outputs/* outputs_dev/*

          # Wipe state branch
          if git rev-parse --verify huntx-state >/dev/null 2>&1; then
            git push origin --delete huntx-state 2>/dev/null || true
            echo "Deleted huntx-state branch"
          fi

          # Recreate READMEs
          mkdir -p outputs outputs_dev
          echo -e "# HuntX Outputs\n\nAuto-generated build output. Do not edit manually." > outputs/README.md
          echo -e "# Dev Outputs\n\nAuto-generated with 48h rolling window. Do not edit manually." > outputs_dev/README.md

          echo "Reset complete â€” all sources will be first-seen on this run."

      - name: Run huntx
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          PUBLISH_BOT_TOKEN: ${{ secrets.PUBLISH_BOT_TOKEN }}
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_USER_SESSION: ${{ secrets.TELEGRAM_USER_SESSION }}
          HUNTX_MAX_WORKERS: ${{ env.MAX_WORKERS }}
          HUNTX_BOT_TIMEOUT: ${{ env.BOT_TIMEOUT }}
          LOG_LEVEL: INFO
        run: |
          huntx \
            --config configs/config.prod.yaml \
            --data-dir persist/data \
            --db-path persist/state.db \
            run \
            --bot-timeout ${{ env.BOT_TIMEOUT }}

      - name: Verify & package output
        env:
          HUNTX_DATA_DIR: persist/data
        run: python scripts/verify_output.py

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: huntx-output
          path: persist/data/dist/
          retention-days: 4

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: huntx-logs
          path: persist/data/logs/
          retention-days: 4

      - name: Commit outputs to main
        run: |
          git config user.name "huntx-bot"
          git config user.email "huntx-bot@users.noreply.github.com"

          git add outputs/ outputs_dev/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No output changes."
          else
            git commit -m "Update outputs [skip ci]"
            git push origin HEAD
          fi

      - name: Persist state
        run: |
          mkdir -p /tmp/state_commit/data_archive
          cp persist/state.db /tmp/state_commit/state.db
          cp -r persist/data/archive/* /tmp/state_commit/data_archive/ 2>/dev/null || true

          if git rev-parse --verify huntx-state >/dev/null 2>&1; then
            git checkout huntx-state
            git rm -rf . 2>/dev/null || true
          else
            git checkout --orphan huntx-state
            git rm -rf . 2>/dev/null || true
          fi

          cp /tmp/state_commit/state.db .
          cp -r /tmp/state_commit/data_archive . 2>/dev/null || true

          git add state.db data_archive 2>/dev/null || git add state.db

          if git diff --cached --quiet; then
            echo "No state changes."
          else
            git commit -m "Update state [skip ci]"
            git push origin HEAD:huntx-state
          fi
