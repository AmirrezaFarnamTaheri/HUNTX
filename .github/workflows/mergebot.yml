name: mergebot

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:
    inputs:
      max_workers:
        description: "Number of parallel ingestion workers"
        required: false
        default: "10"

permissions:
  contents: write

concurrency:
  group: mergebot
  cancel-in-progress: false

env:
  MAX_WORKERS: ${{ github.event.inputs.max_workers || '10' }}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          docker system prune -af 2>/dev/null || true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Prepare directories
        run: mkdir -p persist/data/{raw,output,dist,rejects,archive,state,logs}

      - name: Restore state
        run: |
          git fetch origin mergebot-state:mergebot-state 2>/dev/null || echo "No state branch yet"

          if git show mergebot-state:state.db > persist/state.db 2>/dev/null; then
            echo "Restored state.db"
          else
            echo "Starting fresh"
          fi

          if git ls-tree -d mergebot-state:data_archive >/dev/null 2>&1; then
            git checkout mergebot-state -- data_archive
            cp -r data_archive/* persist/data/archive/ 2>/dev/null || true
            rm -rf data_archive
          fi

      - name: Run mergebot
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          PUBLISH_BOT_TOKEN: ${{ secrets.PUBLISH_BOT_TOKEN }}
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_USER_SESSION: ${{ secrets.TELEGRAM_USER_SESSION }}
          MERGEBOT_MAX_WORKERS: ${{ env.MAX_WORKERS }}
          LOG_LEVEL: INFO
        run: |
          mergebot \
            --config configs/config.prod.yaml \
            --data-dir persist/data \
            --db-path persist/state.db \
            run

      - name: Verify & package output
        env:
          MERGEBOT_DATA_DIR: persist/data
        run: python scripts/verify_output.py

      - name: Upload output
        uses: actions/upload-artifact@v4
        with:
          name: mergebot-output
          path: persist/data/dist/
          retention-days: 4

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: mergebot-logs
          path: persist/data/logs/
          retention-days: 4

      - name: Persist state
        run: |
          git config user.name "mergebot-bot"
          git config user.email "mergebot-bot@users.noreply.github.com"

          mkdir -p /tmp/state_commit/data_archive
          cp persist/state.db /tmp/state_commit/state.db
          cp -r persist/data/archive/* /tmp/state_commit/data_archive/ 2>/dev/null || true

          if git rev-parse --verify mergebot-state >/dev/null 2>&1; then
            git checkout mergebot-state
            git rm -rf . 2>/dev/null || true
          else
            git checkout --orphan mergebot-state
            git rm -rf . 2>/dev/null || true
          fi

          cp /tmp/state_commit/state.db .
          cp -r /tmp/state_commit/data_archive . 2>/dev/null || true

          git add state.db data_archive 2>/dev/null || git add state.db

          if git diff --cached --quiet; then
            echo "No state changes."
          else
            git commit -m "Update state [skip ci]"
            git push origin HEAD:mergebot-state
          fi
